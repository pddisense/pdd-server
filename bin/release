#!/bin/bash
# PDD is a platform for privacy-preserving Web searches collection.
# Copyright (C) 2016-2018 Vincent Primault <v.primault@ucl.ac.uk>
#
# PDD is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PDD is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PDD.  If not, see <http://www.gnu.org/licenses/>.

set -e

dist_dir=dist
rm -rf ${dist_dir} && mkdir -p ${dist_dir}

function print_help_and_exit {
cat <<EOF
Usage: $0 [-help] [-publish]

  -help      Print this help message and exit
  -publish   Publish (default: false, which does not publish anything)
EOF
exit 0
}

publish=0
for opt in "$@"
do
  case "$opt" in
    -publish)
      publish=1
      ;;
    -help)
      print_help_and_exit
      ;;
    *)
      echo "Unknown option $opt"
      print_help_and_exit
      ;;
  esac
done

bazel build pdd/java/ucl/pdd/dashboard:dashboard_deploy.jar --define env=production
cp bazel-bin/pdd/java/ucl/pdd/dashboard/dashboard_deploy.jar ${dist_dir}/pdd-dashboard.jar

bazel build pdd/java/ucl/pdd/server:server_deploy.jar --define env=production
cp bazel-bin/pdd/java/ucl/pdd/server/server_deploy.jar ${dist_dir}/pdd-server.jar

if [[ ${publish} == 1 ]]; then
  echo "Publishing Docker images..."
  bazel run pdd/java/ucl/pdd/server:publish
  bazel run pdd/java/ucl/pdd/dashboard:publish --define env=production
fi
